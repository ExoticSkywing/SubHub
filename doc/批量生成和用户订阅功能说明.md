# 批量生成和用户订阅功能说明

## 📋 第一批功能实现完成

### ✅ 已完成功能

1. **配置模块（anti-share-config.js）**
   - 所有关键参数集中管理
   - 支持测试模式快速切换
   - 包含反共享、批量生成、数据清理等配置

2. **批量生成API（/api/batch-generate）**
   - POST接口，批量生成用户订阅链接
   - 参数验证（数量、有效期范围）
   - 自动生成唯一Token
   - 三段式URL格式
   - Telegram通知

3. **三段式URL路由**
   - 支持 `/profileToken/profileId/userToken` 格式
   - 向后兼容现有双段式和单段式URL
   - 不影响现有功能

4. **用户订阅处理（handleUserSubscription）**
   - 首次访问自动激活
   - 过期检测
   - 访问统计
   - Telegram激活通知

---

## 🔧 测试模式配置

### 启用测试模式

编辑 `functions/anti-share-config.js`：

```javascript
export const TEST_MODE = {
  ENABLED: true,  // 改为 true 启用测试模式
  
  QUICK_CONFIG: {
    MAX_DEVICES: 2,              // 测试时只需2台设备
    TOKEN_LENGTH: 4,              // Token长度改为4位，方便测试
    MAX_TOKENS_PER_BATCH: 10,     // 单次最多生成10个
    DEFAULT_DURATION_DAYS: 1,     // 有效期1天
    RATE_LIMITS: { 1: 3, 2: 5 }   // 访问次数限制
  }
};
```

**测试模式的优势：**
- Token更短（4位），方便手动输入
- 批量生成数量少，避免污染数据库
- 有效期短（1天），快速测试过期逻辑
- 设备数量少（2台），快速触发限制

---

## 🧪 测试流程

### 1. 批量生成测试

**步骤1：创建订阅组**
- 在管理界面创建一个测试订阅组
- 订阅组名称：`测试套餐`
- 自定义ID：`test`
- 添加1-2个订阅源或手动节点

**步骤2：调用批量生成API**

```bash
curl -X POST https://your-domain.com/api/batch-generate \
  -H "Content-Type: application/json" \
  -d '{
    "profileId": "test",
    "count": 5,
    "duration": 1
  }'
```

**预期响应：**
```json
{
  "success": true,
  "count": 5,
  "tokens": [
    {
      "token": "a3f5",
      "url": "https://your-domain.com/publicshare/test/a3f5",
      "status": "pending",
      "createdAt": 1699520000000
    },
    ...
  ],
  "profileName": "测试套餐"
}
```

---

### 2. 用户订阅测试

**测试用例1：首次激活**

```bash
# 使用生成的链接
curl https://your-domain.com/publicshare/test/a3f5
```

**预期结果：**
- ✅ 返回订阅节点列表
- ✅ Telegram收到激活通知
- ✅ KV中 `user:a3f5` 状态变为 `activated`

**测试用例2：重复访问**

```bash
# 再次访问同一链接
curl https://your-domain.com/publicshare/test/a3f5
```

**预期结果：**
- ✅ 正常返回节点
- ✅ 不再发送激活通知
- ✅ 访问统计增加

**测试用例3：过期检测**

```bash
# 等待1天后（或手动修改KV中的expiresAt时间戳）
curl https://your-domain.com/publicshare/test/a3f5
```

**预期结果：**
- ✅ 返回过期提示节点
- ✅ 节点名称包含"订阅已过期"

**测试用例4：无效Token**

```bash
curl https://your-domain.com/publicshare/test/xxxx
```

**预期结果：**
- ✅ 返回 404 "订阅链接无效或已被删除"

---

### 3. 兼容性测试

**测试现有功能不受影响：**

```bash
# 单段式URL（管理员专用）
curl https://your-domain.com/nebuluxe

# 双段式URL（订阅组分享）
curl https://your-domain.com/publicshare/gyshare
```

**预期结果：**
- ✅ 两种URL格式正常工作
- ✅ 返回正确的节点列表

---

## 📊 数据结构说明

### 用户Token数据（KV）

**键名：** `user:${userToken}`

**数据结构：**
```json
{
  "userToken": "a3f5",
  "profileId": "test",
  "status": "activated",
  "createdAt": 1699520000000,
  "activatedAt": 1699520100000,
  "expiresAt": 1699606500000,
  "duration": 86400000,
  "devices": {},
  "stats": {
    "totalRequests": 5,
    "lastRequest": 1699520500000,
    "dailyCount": 5,
    "dailyDate": "2025-11-09"
  }
}
```

**字段说明：**
- `status`: `pending`（未激活）、`activated`（已激活）、`expired`（已过期）
- `duration`: 有效期（毫秒）
- `devices`: 反共享数据（第二批实现）
- `stats`: 访问统计

---

## 🔑 配置参数速查

### 常用配置（anti-share-config.js）

| 参数 | 默认值 | 测试建议 | 说明 |
|------|--------|---------|------|
| `MAX_TOKENS_PER_BATCH` | 1000 | 10 | 单次最多生成数量 |
| `TOKEN_LENGTH` | 8 | 4-6 | Token字符串长度 |
| `DEFAULT_DURATION_DAYS` | 30 | 1 | 默认有效期（天） |
| `MAX_DEVICES` | 4 | 2 | 最大设备数（反共享） |

---

## 🎯 下一步：第二批功能

待实现功能：
1. ✅ 反共享机制
   - 设备识别（deviceId = hash(User-Agent)）
   - 城市检测（第3、4台设备）
   - 访问次数限制（可选）

2. ✅ 前端批量生成界面
   - 订阅组卡片添加"批量生成"按钮
   - 批量生成模态框
   - 生成结果展示和导出

3. ✅ 数据管理
   - Token列表查看
   - 手动删除Token
   - 使用统计

---

## 📝 注意事项

1. **测试完成后记得关闭测试模式**
   ```javascript
   export const TEST_MODE = {
     ENABLED: false,  // 改回 false
     ...
   };
   ```

2. **清理测试数据**
   - 测试生成的Token会占用KV存储
   - 可以通过Cloudflare Dashboard手动删除
   - 或实现批量清理API

3. **生产环境配置**
   - Token长度建议8位以上
   - 批量生成上限1000足够
   - 有效期根据实际套餐设置

---

## 🐛 故障排查

### 问题1：批量生成失败

**可能原因：**
- 订阅组不存在或ID不匹配
- 参数超出范围
- KV写入失败

**解决方案：**
- 检查 `profileId` 是否正确
- 查看浏览器控制台或Workers日志

### 问题2：用户订阅返回403

**可能原因：**
- profileToken不匹配
- URL格式错误

**解决方案：**
- 确认URL是三段式：`/publicshare/test/a3f5`
- 检查管理界面的"订阅组分享Token"设置

### 问题3：激活通知未收到

**可能原因：**
- Telegram配置未设置
- BotToken或ChatID错误
- 通知开关关闭

**解决方案：**
- 检查 `anti-share-config.js` 中 `NOTIFY_ON_ACTIVATION: true`
- 验证Telegram配置

---

## ✅ 完成清单

- [x] 配置模块创建
- [x] 批量生成API实现
- [x] 三段式URL路由
- [x] 用户订阅处理
- [x] 激活机制
- [x] 过期检测
- [x] 测试模式支持
- [ ] 反共享机制（第二批）
- [ ] 前端批量生成界面（第二批）
- [ ] Token管理界面（第三批）

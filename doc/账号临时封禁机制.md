# 账号临时封禁（悬挂）机制

## 🎯 设计目标

对可疑的高频访问行为进行临时封禁，防止滥用和共享，同时提供自动解冻机制。

---

## 📋 触发条件

### **同时满足以下条件**
1. **临时封禁功能已启用**：`SUSPEND_ENABLED = true`
2. **设备数达到上限**（可选）：`currentDeviceCount >= MAX_DEVICES`（由`SUSPEND_REQUIRE_MAX_DEVICES`控制）
3. **访问次数超过阈值**：`dailyCount > rateLimit × SUSPEND_THRESHOLD_PERCENT / 100`

### **触发示例**
```javascript
配置：
MAX_DEVICES = 4
RATE_LIMITS[4] = 20
SUSPEND_THRESHOLD_PERCENT = 50
SUSPEND_REQUIRE_MAX_DEVICES = true
SUSPEND_DURATION_DAYS = 3

场景：
用户已绑定4台设备（达到上限）
当天已访问11次（超过20次的50%）

结果：触发临时封禁，3天后自动解冻
```

---

## 🔒 封禁效果

### **封禁状态**
```javascript
userData.suspend = {
    at: 1699612800000,              // 封禁时间戳
    until: 1699872000000,            // 解封时间戳（3天后）
    reason: "可疑的高频访问行为...", // 封禁原因
    deviceCount: 4,                  // 触发时的设备数
    dailyCount: 11,                  // 触发时的访问次数
    rateLimit: 20                    // 触发时的限制
}
```

### **封禁期间行为**
- ❌ **所有访问请求被拒绝**
- 📱 **客户端显示封禁错误节点**
  ```
  🚫 账号已临时封禁
  原因: 可疑的高频访问行为（4台设备，今日已访问11次，超过限制20次的50%）
  剩余封禁时间: 2天
  解封时间: 2025/11/13 16:30:00
  ⏳ 到期后自动解冻
  如着急请联系服务商
  ```
- 📨 **发送Telegram通知**
  ```
  🚫 账号已临时封禁
  
  IP 地址: 119.98.117.21
  国家: 🇨🇳 China
  城市: Wuhan
  
  Token: os7h
  今日访问: 11 / 20 (4台设备)
  触发阈值: 10次 (50%)
  设备ID: -vsj4cz
  城市: Wuhan
  IP: 119.98.117.21
  封禁时长: 3天
  解封时间: 2025/11/13 16:30:00
  ```

### **自动解冻**
- ✅ **到期后自动解除封禁**
- 🔄 **下次访问时检测并清除`suspend`字段**
- 📝 **日志记录**：`Account auto-unfrozen after suspension`

---

## ⚙️ 配置参数

### **anti-share-config.js**
```javascript
export const ANTI_SHARE_CONFIG = {
  // 账号临时封禁（悬挂）配置
  SUSPEND_ENABLED: true,                    // 是否启用临时封禁功能
  SUSPEND_THRESHOLD_PERCENT: 50,            // 触发封禁的访问次数百分比阈值
  SUSPEND_REQUIRE_MAX_DEVICES: true,        // 是否要求设备数达到上限才触发封禁
  SUSPEND_DURATION_DAYS: 3                  // 封禁时长（天）
};
```

### **参数说明**

#### `SUSPEND_ENABLED`
- **类型**: `boolean`
- **默认值**: `true`
- **说明**: 是否启用临时封禁功能
- **建议**: 生产环境建议启用，测试环境可关闭

#### `SUSPEND_THRESHOLD_PERCENT`
- **类型**: `number`
- **默认值**: `50`
- **说明**: 触发封禁的访问次数百分比阈值
- **计算**: `suspendThreshold = rateLimit × SUSPEND_THRESHOLD_PERCENT / 100`
- **示例**:
  - 50% → 20次限制时，11次触发
  - 75% → 20次限制时，16次触发
  - 90% → 20次限制时，19次触发

#### `SUSPEND_REQUIRE_MAX_DEVICES`
- **类型**: `boolean`
- **默认值**: `true`
- **说明**: 是否要求设备数达到上限才触发封禁
- **建议**:
  - `true`: 只对设备数已满的账户进行封禁（更严格）
  - `false`: 对所有账户进行封禁（更宽松）

#### `SUSPEND_DURATION_DAYS`
- **类型**: `number`
- **默认值**: `3`
- **说明**: 封禁时长（天）
- **建议**:
  - 严格模式: 7天
  - 标准模式: 3天
  - 宽松模式: 1天

---

## 🔍 检测流程

### **检测顺序**
```
1. 【检测0】账号临时封禁检测（优先级最高）
   ├─ 检查是否已封禁
   ├─ 如果封禁已过期 → 自动解冻
   └─ 如果封禁仍有效 → 拒绝访问

2. 【检测1】设备数量限制
3. 【检测2】城市检测
4. 【检测3.1】触发临时封禁检测
   ├─ 检查是否启用封禁功能
   ├─ 检查设备数是否达到上限（可选）
   ├─ 检查访问次数是否超过阈值
   └─ 触发封禁并发送通知
5. 【检测3.2】访问次数限制
```

### **代码位置**

#### 1. 封禁状态检查（第1978-1998行）
```javascript
// 3.5 【检测0】账号临时封禁检测（优先级最高）
if (userData.suspend) {
    const now = Date.now();
    
    // 检查封禁是否已过期
    if (userData.suspend.until && now >= userData.suspend.until) {
        // 封禁已过期，自动解冻
        delete userData.suspend;
    } else {
        // 封禁仍然有效，拒绝访问
        return {
            allowed: false,
            reason: 'suspended',
            suspendUntil: userData.suspend.until,
            suspendReason: userData.suspend.reason
        };
    }
}
```

#### 2. 封禁触发检测（第2164-2208行）
```javascript
// 【检测3.1】触发临时封禁检测
if (config.antiShare.SUSPEND_ENABLED) {
    const suspendThreshold = Math.floor(rateLimit * config.antiShare.SUSPEND_THRESHOLD_PERCENT / 100);
    const deviceAtMax = config.antiShare.SUSPEND_REQUIRE_MAX_DEVICES 
        ? (currentDeviceCount >= config.antiShare.MAX_DEVICES)
        : true;
    
    // 条件：设备数达到上限 && 访问次数超过阈值（50%）
    if (deviceAtMax && userData.stats.dailyCount > suspendThreshold) {
        // 触发临时封禁
        const suspendDurationMs = config.antiShare.SUSPEND_DURATION_DAYS * 24 * 60 * 60 * 1000;
        const suspendUntil = Date.now() + suspendDurationMs;
        const suspendReason = `可疑的高频访问行为...`;
        
        userData.suspend = {
            at: Date.now(),
            until: suspendUntil,
            reason: suspendReason,
            deviceCount: currentDeviceCount,
            dailyCount: userData.stats.dailyCount,
            rateLimit
        };
        
        // 发送Telegram通知 + 返回封禁
    }
}
```

#### 3. 错误提示生成（第1930-1948行）
```javascript
function generateSuspendError(suspendUntil, suspendReason) {
    const unfreezeDate = new Date(suspendUntil).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
    const remainingDays = Math.ceil((suspendUntil - Date.now()) / (1000 * 60 * 60 * 24));
    const errorNodes = [
        '🚫 账号已临时封禁',
        `原因: ${suspendReason}`,
        `剩余封禁时间: ${remainingDays}天`,
        `解封时间: ${unfreezeDate}`,
        '⏳ 到期后自动解冻',
        '如着急请联系服务商'
    ];
    return errorNodes.join('\n');
}
```

---

## 📊 使用场景

### **场景1：正常使用（不触发）**
```
配置：MAX_DEVICES=4, RATE_LIMITS[4]=20, SUSPEND_THRESHOLD=50%

用户有4台设备
今日访问10次（未超过10次阈值）
→ ✅ 继续使用，不触发封禁
```

### **场景2：高频访问（触发封禁）**
```
配置：MAX_DEVICES=4, RATE_LIMITS[4]=20, SUSPEND_THRESHOLD=50%

用户有4台设备
今日访问11次（超过10次阈值）
→ ❌ 触发封禁，3天后解冻
```

### **场景3：设备未满（不触发）**
```
配置：MAX_DEVICES=4, SUSPEND_REQUIRE_MAX_DEVICES=true

用户有2台设备（未达上限）
今日访问100次
→ ✅ 不触发封禁（因为设备数未达上限）
→ 但会触发访问次数限制
```

### **场景4：自动解冻**
```
用户被封禁3天
第4天：尝试访问订阅
→ ✅ 自动解冻，正常访问
→ 日志：Account auto-unfrozen
```

---

## 🎯 最佳实践

### **配置建议**

#### 严格模式（适合高价值订阅）
```javascript
SUSPEND_ENABLED: true,
SUSPEND_THRESHOLD_PERCENT: 75,        // 75% 触发
SUSPEND_REQUIRE_MAX_DEVICES: true,    // 必须设备满
SUSPEND_DURATION_DAYS: 7              // 封禁7天
```

#### 标准模式（推荐）
```javascript
SUSPEND_ENABLED: true,
SUSPEND_THRESHOLD_PERCENT: 50,        // 50% 触发
SUSPEND_REQUIRE_MAX_DEVICES: true,    // 必须设备满
SUSPEND_DURATION_DAYS: 3              // 封禁3天
```

#### 宽松模式（适合测试/体验）
```javascript
SUSPEND_ENABLED: true,
SUSPEND_THRESHOLD_PERCENT: 90,        // 90% 触发
SUSPEND_REQUIRE_MAX_DEVICES: false,   // 不要求设备满
SUSPEND_DURATION_DAYS: 1              // 封禁1天
```

### **监控建议**
1. 定期检查封禁账户数量
2. 分析封禁原因分布
3. 关注自动解冻后的行为
4. 建立人工申诉机制

### **用户沟通**
1. 在激活通知中说明封禁政策
2. 提供清晰的申诉途径
3. 考虑提供"手动解封"功能（需人工审核）

---

## 📋 测试清单

### **基础测试**
- [ ] 1. 设备未满 + 高频访问 → 不触发封禁
- [ ] 2. 设备已满 + 访问次数=阈值 → 不触发封禁
- [ ] 3. 设备已满 + 访问次数>阈值 → 触发封禁
- [ ] 4. 被封禁后尝试访问 → 返回封禁错误
- [ ] 5. 封禁期满后访问 → 自动解冻

### **边界测试**
- [ ] 6. 访问次数=阈值（临界值）
- [ ] 7. 访问次数=阈值+1（刚好触发）
- [ ] 8. 设备数=MAX_DEVICES-1（刚好不触发）
- [ ] 9. 设备数=MAX_DEVICES（可能触发）

### **Telegram通知测试**
- [ ] 10. 触发封禁时收到通知
- [ ] 11. 通知包含完整信息（访问次数、阈值、解封时间等）
- [ ] 12. 封禁期间访问不重复发送通知

### **自动解冻测试**
- [ ] 13. 封禁到期后访问 → 自动解冻
- [ ] 14. 自动解冻后 → `userData.suspend` 被删除
- [ ] 15. 自动解冻后 → 可以正常访问

### **配置测试**
- [ ] 16. `SUSPEND_ENABLED=false` → 不触发封禁
- [ ] 17. `SUSPEND_REQUIRE_MAX_DEVICES=false` → 设备未满也可能触发
- [ ] 18. `SUSPEND_THRESHOLD_PERCENT=100` → 永远不触发

---

## 🔧 管理操作

### **手动解封（需在Worker环境中执行）**
```javascript
// 1. 读取用户数据
const userData = JSON.parse(await env.MISUB_KV.get('user:xxx'));

// 2. 删除封禁状态
delete userData.suspend;

// 3. 保存
await env.MISUB_KV.put('user:xxx', JSON.stringify(userData));

console.log('Account manually unfrozen');
```

### **查看封禁信息**
```javascript
const userData = JSON.parse(await env.MISUB_KV.get('user:xxx'));

if (userData.suspend) {
    console.log('Suspended at:', new Date(userData.suspend.at));
    console.log('Suspend until:', new Date(userData.suspend.until));
    console.log('Reason:', userData.suspend.reason);
    console.log('Device count:', userData.suspend.deviceCount);
    console.log('Daily count:', userData.suspend.dailyCount);
}
```

### **批量检查封禁账户**
```javascript
// 需要遍历所有user:前缀的KV
const allKeys = await env.MISUB_KV.list({ prefix: 'user:' });
const suspendedAccounts = [];

for (const key of allKeys.keys) {
    const userData = JSON.parse(await env.MISUB_KV.get(key.name));
    if (userData.suspend) {
        suspendedAccounts.push({
            token: key.name.replace('user:', ''),
            suspendUntil: userData.suspend.until,
            reason: userData.suspend.reason
        });
    }
}

console.log(`Found ${suspendedAccounts.length} suspended accounts`);
```

---

## 📈 统计指标

### **建议监控的指标**
1. **封禁率**: `封禁账户数 / 总账户数`
2. **误封率**: `人工申诉成功数 / 封禁账户数`
3. **自动解冻率**: `自动解冻数 / 封禁账户数`
4. **重复封禁率**: `二次封禁数 / 自动解冻数`

### **告警阈值建议**
- 封禁率 > 10% → 检查配置是否过于严格
- 误封率 > 20% → 调整阈值或解除机制
- 重复封禁率 > 50% → 考虑延长封禁时间

---

**创建日期**: 2025/11/10  
**版本**: 1.0  
**作者**: Cascade AI  
**适用版本**: MiSub v2.0+

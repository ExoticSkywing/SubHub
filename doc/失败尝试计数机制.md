# å¤±è´¥å°è¯•è®¡æ•°æœºåˆ¶

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

### **åŸå§‹é—®é¢˜**
ç”¨æˆ·è§¦å‘"æ–°è®¾å¤‡æ–°åŸå¸‚"é™åˆ¶ï¼Œå¤šæ¬¡åˆ·æ–°è®¢é˜…ï¼š
```
ğŸš« æ–°è®¾å¤‡æ–°åŸå¸‚ (6æ¬¡å°è¯•)
â†’ æ¯æ¬¡éƒ½è¢«æ‹’ç»
â†’ ä½† dailyCount ä»ç„¶æ˜¯0ï¼ˆå› ä¸ºè¯·æ±‚æœªæˆåŠŸï¼‰
â†’ å°ç¦æ¡ä»¶ä¸æ»¡è¶³
â†’ ç”¨æˆ·å¯ä»¥æ— é™åˆ·æ–°
```

### **æ ¸å¿ƒé—®é¢˜**
1. **è®¾å¤‡æ•°æœªè¾¾ä¸Šé™**ï¼š`SUSPEND_REQUIRE_MAX_DEVICES: true`ï¼Œä½†åªæœ‰2å°è®¾å¤‡
2. **è¢«æ‹’ç»çš„è¯·æ±‚ä¸è®¡æ•°**ï¼š`dailyCount`åªè®°å½•æˆåŠŸçš„è¯·æ±‚ï¼Œå¤±è´¥è¯·æ±‚ä¸å¢åŠ 

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### **æ–¹æ¡ˆ1ï¼šå…³é—­è®¾å¤‡æ•°é™åˆ¶**
```javascript
SUSPEND_REQUIRE_MAX_DEVICES: false  // ä¸è¦æ±‚è®¾å¤‡æ•°è¾¾åˆ°ä¸Šé™
```

**æ•ˆæœ**ï¼šä»»ä½•è®¾å¤‡æ•°éƒ½å¯ä»¥è§¦å‘å°ç¦

---

### **æ–¹æ¡ˆ2ï¼šæ·»åŠ å¤±è´¥å°è¯•è®¡æ•°å™¨ï¼ˆæ¨èï¼‰â­**

#### **æ–°å¢å­—æ®µ**
```javascript
userData.stats.failedAttempts  // å¤±è´¥å°è¯•æ¬¡æ•°
```

#### **è§¦å‘æ¡ä»¶**
```javascript
// åŸå§‹æ¡ä»¶ï¼ˆæˆåŠŸè®¿é—®è¿‡å¤šï¼‰
suspendByDailyCount = dailyCount > suspendThreshold

// æ–°å¢æ¡ä»¶ï¼ˆå¤±è´¥å°è¯•è¿‡å¤šï¼‰
suspendByFailedAttempts = failedAttempts >= SUSPEND_FAILED_ATTEMPTS_THRESHOLD

// ç»¼åˆæ¡ä»¶
if (deviceAtMax && (suspendByDailyCount || suspendByFailedAttempts)) {
    // è§¦å‘å°ç¦
}
```

---

## ğŸ”§ å®ç°ç»†èŠ‚

### **1. è®°å½•å¤±è´¥å°è¯•**

åœ¨åå…±äº«æ£€æµ‹å¤±è´¥æ—¶å¢åŠ è®¡æ•°å™¨ï¼š

```javascript
// ç¬¬2201-2210è¡Œ
// è®°å½•å¤±è´¥å°è¯•æ¬¡æ•°
userData.stats.failedAttempts = (userData.stats.failedAttempts || 0) + 1;

return {
    allowed: false,
    reason: 'new_device_new_city',
    deviceId,
    city,
    failedAttempts: userData.stats.failedAttempts
};
```

---

### **2. å°ç¦æ£€æµ‹é€»è¾‘**

```javascript
// ç¬¬2328-2338è¡Œ
// åˆå§‹åŒ–å¤±è´¥å°è¯•æ¬¡æ•°
const failedAttempts = userData.stats.failedAttempts || 0;

// å¤±è´¥å°è¯•é˜ˆå€¼ä»é…ç½®è¯»å–
const failedAttemptsThreshold = config.antiShare.SUSPEND_FAILED_ATTEMPTS_THRESHOLD || 5;
const suspendByFailedAttempts = failedAttempts >= failedAttemptsThreshold;
const suspendByDailyCount = userData.stats.dailyCount > suspendThreshold;

// è§¦å‘æ¡ä»¶ï¼šè®¾å¤‡è¾¾ä¸Šé™ && (è®¿é—®è¶…é™ || å¤±è´¥å°è¯•è¿‡å¤š)
if (deviceAtMax && (suspendByDailyCount || suspendByFailedAttempts)) {
    // è§¦å‘ä¸´æ—¶å°ç¦
}
```

---

### **3. å°ç¦åŸå› åŒºåˆ†**

æ ¹æ®è§¦å‘åŸå› ç”Ÿæˆä¸åŒçš„å°ç¦ç†ç”±ï¼š

```javascript
// ç¬¬2343-2348è¡Œ
if (suspendByFailedAttempts) {
    suspendReason = `å¯ç–‘çš„é«˜é¢‘å¤±è´¥å°è¯•ï¼ˆ${failedAttempts}æ¬¡å¤±è´¥å°è¯•ï¼Œç–‘ä¼¼è´¦å·å…±äº«æˆ–æ»¥ç”¨ï¼‰`;
} else {
    suspendReason = `å¯ç–‘çš„é«˜é¢‘è®¿é—®è¡Œä¸ºï¼ˆ${currentDeviceCount}å°è®¾å¤‡ï¼Œä»Šæ—¥å·²è®¿é—®${userData.stats.dailyCount}æ¬¡ï¼Œè¶…è¿‡é™åˆ¶${rateLimit}æ¬¡çš„${config.antiShare.SUSPEND_THRESHOLD_PERCENT}%ï¼‰`;
}
```

---

### **4. Telegramé€šçŸ¥**

å°ç¦é€šçŸ¥åŒ…å«å¤±è´¥å°è¯•æ¬¡æ•°ä¿¡æ¯ï¼š

```javascript
// ç¬¬2370-2381è¡Œ
if (suspendByFailedAttempts) {
    additionalData += `
- å¤±è´¥å°è¯•: \`${failedAttempts}\` æ¬¡ï¼ˆé˜ˆå€¼: ${failedAttemptsThreshold}æ¬¡ï¼‰
- ä»Šæ—¥è®¿é—®: \`${userData.stats.dailyCount}\` / \`${rateLimit}\` (${currentDeviceCount}å°è®¾å¤‡)
- ç–‘ä¼¼è´¦å·å…±äº«æˆ–æ»¥ç”¨`;
} else {
    additionalData += `
- ä»Šæ—¥è®¿é—®: \`${userData.stats.dailyCount}\` / \`${rateLimit}\` (${currentDeviceCount}å°è®¾å¤‡)
- è§¦å‘é˜ˆå€¼: ${suspendThreshold}æ¬¡ (${config.antiShare.SUSPEND_THRESHOLD_PERCENT}%)
- å¤±è´¥å°è¯•: \`${failedAttempts}\` æ¬¡
- å¯ç–‘çš„é«˜é¢‘è®¿é—®è¡Œä¸º`;
}
```

---

### **5. ä¿å­˜å¤±è´¥è®¡æ•°å™¨**

**å…³é”®**ï¼šå³ä½¿è¯·æ±‚è¢«æ‹’ç»ï¼Œä¹Ÿè¦ä¿å­˜`userData`çš„æ›´æ”¹ï¼š

```javascript
// ç¬¬2800-2807è¡Œï¼ˆShadowrocket/V2rayNGï¼‰
// âš ï¸ é‡è¦ï¼šä¿å­˜userDataçš„æ›´æ”¹ï¼ˆå¤±è´¥è®¡æ•°å™¨ã€å°ç¦çŠ¶æ€ç­‰ï¼‰
// å³ä½¿è¯·æ±‚è¢«æ‹’ç»ï¼Œä¹Ÿè¦ä¿å­˜è¿™äº›ç»Ÿè®¡ä¿¡æ¯
const storageAdapter = await getStorageAdapter(env);
const allUserData = await storageAdapter.get(KV_KEY_USER_DATA) || {};
allUserData[userToken] = userData;
await storageAdapter.put(KV_KEY_USER_DATA, allUserData);
console.log(`[AntiShare] Saved userData after rejection (failedAttempts: ${userData.stats.failedAttempts || 0}, suspended: ${!!userData.suspend})`);
```

**åŒæ ·çš„ä¿å­˜é€»è¾‘**åœ¨Clash/Surge/Loonçš„é”™è¯¯é…ç½®ç”Ÿæˆå‰ä¹Ÿæ‰§è¡Œï¼ˆç¬¬2743-2780è¡Œï¼‰

---

### **6. æ¯æ—¥é‡ç½®**

æ¯å¤©é‡ç½®æ—¶ï¼ŒåŒæ—¶é‡ç½®å¤±è´¥å°è¯•è®¡æ•°å™¨ï¼š

```javascript
// ç¬¬2314-2318è¡Œ
if (!userData.stats.dailyDate || userData.stats.dailyDate !== today) {
    userData.stats.dailyCount = 0;
    userData.stats.dailyDate = today;
    userData.stats.failedAttempts = 0;  // æ¯å¤©é‡ç½®å¤±è´¥å°è¯•è®¡æ•°
}
```

---

## âš™ï¸ é…ç½®é¡¹

### **anti-share-config.js**

```javascript
export const ANTI_SHARE_CONFIG = {
  // è´¦å·ä¸´æ—¶å°ç¦é…ç½®
  SUSPEND_ENABLED: true,                          // å¯ç”¨å°ç¦æœºåˆ¶
  SUSPEND_THRESHOLD_PERCENT: 5,                   // è®¿é—®æ¬¡æ•°ç™¾åˆ†æ¯”é˜ˆå€¼ï¼ˆ5%ï¼‰
  SUSPEND_REQUIRE_MAX_DEVICES: false,             // ä¸è¦æ±‚è®¾å¤‡æ•°è¾¾ä¸Šé™ï¼ˆæµ‹è¯•ï¼šfalseï¼‰
  SUSPEND_DURATION_DAYS: 3,                       // å°ç¦æ—¶é•¿ï¼ˆ3å¤©ï¼‰
  SUSPEND_FAILED_ATTEMPTS_THRESHOLD: 5            // å¤±è´¥å°è¯•é˜ˆå€¼ï¼ˆ5æ¬¡ï¼‰
};
```

### **é…ç½®è¯´æ˜**

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|--------|------|
| `SUSPEND_ENABLED` | `true` | æ˜¯å¦å¯ç”¨å°ç¦æœºåˆ¶ |
| `SUSPEND_THRESHOLD_PERCENT` | `5` | è®¿é—®æ¬¡æ•°è¶…è¿‡é™åˆ¶çš„5%è§¦å‘å°ç¦ |
| `SUSPEND_REQUIRE_MAX_DEVICES` | `false` | ä¸è¦æ±‚è®¾å¤‡æ•°è¾¾ä¸Šé™ï¼ˆä»»ä½•è®¾å¤‡æ•°éƒ½å¯è§¦å‘ï¼‰ |
| `SUSPEND_DURATION_DAYS` | `3` | å°ç¦3å¤© |
| `SUSPEND_FAILED_ATTEMPTS_THRESHOLD` | `5` | å¤±è´¥å°è¯•è¾¾åˆ°5æ¬¡è§¦å‘å°ç¦ |

---

## ğŸ“Š è§¦å‘é€»è¾‘æµç¨‹å›¾

```
ç”¨æˆ·è¯·æ±‚è®¢é˜…
    â†“
åå…±äº«æ£€æµ‹
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æµ‹æ˜¯å¦é€šè¿‡ï¼Ÿ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“           â†“
   é€šè¿‡        å¤±è´¥
    â†“           â†“
å¢åŠ dailyCount  å¢åŠ failedAttempts
    â†“           â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ å°ç¦æ£€æµ‹          â”‚
    â”‚ deviceAtMax &&   â”‚
    â”‚ (dailyCountè¶…é™  â”‚
    â”‚  || failedAttemptsè¶…é™) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
        è§¦å‘å°ç¦
            â†“
    ä¿å­˜suspendçŠ¶æ€
            â†“
    å‘é€Telegramé€šçŸ¥
```

---

## ğŸ¯ æµ‹è¯•åœºæ™¯

### **åœºæ™¯1ï¼šå¤±è´¥å°è¯•è§¦å‘å°ç¦**

**æ­¥éª¤**ï¼š
1. Token: `hoo2`ï¼Œå·²æœ‰2å°è®¾å¤‡ï¼ˆSeoul, Shanghaiï¼‰
2. ä½¿ç”¨Loonå®¢æˆ·ç«¯ä»Los Angelesè®¿é—®
3. è§¦å‘"æ–°è®¾å¤‡æ–°åŸå¸‚"é™åˆ¶

**é¢„æœŸç»“æœ**ï¼š
```
ç¬¬1æ¬¡: âŒ è¢«æ‹’ç»ï¼ŒfailedAttempts=1
ç¬¬2æ¬¡: âŒ è¢«æ‹’ç»ï¼ŒfailedAttempts=2
ç¬¬3æ¬¡: âŒ è¢«æ‹’ç»ï¼ŒfailedAttempts=3
ç¬¬4æ¬¡: âŒ è¢«æ‹’ç»ï¼ŒfailedAttempts=4
ç¬¬5æ¬¡: âŒ è¢«æ‹’ç»ï¼ŒfailedAttempts=5
ç¬¬6æ¬¡: ğŸš« è§¦å‘å°ç¦ï¼

Telegramé€šçŸ¥:
ğŸš« è´¦å·å·²ä¸´æ—¶å°ç¦
è§¦å‘åŸå› :
- å¤±è´¥å°è¯•: 5æ¬¡ï¼ˆé˜ˆå€¼: 5æ¬¡ï¼‰
- ä»Šæ—¥è®¿é—®: 0 / 5 (2å°è®¾å¤‡)
- ç–‘ä¼¼è´¦å·å…±äº«æˆ–æ»¥ç”¨
```

---

### **åœºæ™¯2ï¼šæˆåŠŸè®¿é—®è§¦å‘å°ç¦**

**æ­¥éª¤**ï¼š
1. Token: `nd11`ï¼Œ1å°è®¾å¤‡
2. æ­£å¸¸è®¿é—®ï¼Œæ¯æ¬¡éƒ½æˆåŠŸ

**é¢„æœŸç»“æœ**ï¼š
```
è®¿é—®æ¬¡æ•°é™åˆ¶: 3æ¬¡ï¼ˆ1å°è®¾å¤‡ï¼‰
å°ç¦é˜ˆå€¼: 3 Ã— 5% = 0.15æ¬¡

ç¬¬1æ¬¡: âœ… æˆåŠŸï¼ŒdailyCount=1ï¼Œè§¦å‘å°ç¦ï¼

Telegramé€šçŸ¥:
ğŸš« è´¦å·å·²ä¸´æ—¶å°ç¦
è§¦å‘åŸå› :
- ä»Šæ—¥è®¿é—®: 1 / 3 (1å°è®¾å¤‡)
- è§¦å‘é˜ˆå€¼: 0æ¬¡ (5%)
- å¤±è´¥å°è¯•: 0æ¬¡
- å¯ç–‘çš„é«˜é¢‘è®¿é—®è¡Œä¸º
```

---

## ğŸ“ Cloudflareæ—¥å¿—ç¤ºä¾‹

### **å¤±è´¥å°è¯•è®°å½•**
```
[AntiShare] Account hoo2 æ–°è®¾å¤‡æ–°åŸå¸‚ rejected
[AntiShare] Saved userData after rejection (failedAttempts: 1, suspended: false)

[AntiShare] Account hoo2 æ–°è®¾å¤‡æ–°åŸå¸‚ rejected
[AntiShare] Saved userData after rejection (failedAttempts: 2, suspended: false)

...

[AntiShare] Account hoo2 æ–°è®¾å¤‡æ–°åŸå¸‚ rejected
[AntiShare] Saved userData after rejection (failedAttempts: 5, suspended: false)

[AntiShare] Account hoo2 suspended until 2025/11/14 02:17:09 (UTC+8)
[AntiShare] Saved userData after rejection (failedAttempts: 5, suspended: true)
```

---

## ğŸ›¡ï¸ é˜²æŠ¤æ•ˆæœ

### **ä¿®å¤å‰**
```
âŒ ç”¨æˆ·å¯ä»¥æ— é™åˆ·æ–°"æ–°è®¾å¤‡æ–°åŸå¸‚"
âŒ failedAttemptsä¸è®°å½•
âŒ å°ç¦æ¡ä»¶æ°¸è¿œä¸æ»¡è¶³
âŒ é™åˆ¶æœºåˆ¶å®Œå…¨å¤±æ•ˆ
```

### **ä¿®å¤å**
```
âœ… å¤±è´¥å°è¯•è¢«è®°å½•
âœ… è¾¾åˆ°é˜ˆå€¼ï¼ˆ5æ¬¡ï¼‰è§¦å‘å°ç¦
âœ… å°ç¦çŠ¶æ€æŒä¹…åŒ–
âœ… Telegramé€šçŸ¥ç®¡ç†å‘˜
âœ… é™åˆ¶æœºåˆ¶ç”Ÿæ•ˆ
```

---

## ğŸ”„ æ¯æ—¥é‡ç½®æœºåˆ¶

### **é‡ç½®æ—¶æœº**
æ¯å¤©0ç‚¹ï¼ˆUTCæ—¶åŒºï¼‰ï¼Œå½“`dailyDate !== today`æ—¶è§¦å‘

### **é‡ç½®å†…å®¹**
```javascript
userData.stats.dailyCount = 0;         // æˆåŠŸè®¿é—®æ¬¡æ•°
userData.stats.dailyDate = today;      // æ›´æ–°æ—¥æœŸ
userData.stats.failedAttempts = 0;     // å¤±è´¥å°è¯•æ¬¡æ•°
```

### **ä¿ç•™å†…å®¹**
```javascript
userData.stats.totalRequests           // æ€»è®¿é—®æ¬¡æ•°ï¼ˆç´¯è®¡ï¼‰
userData.stats.lastRequest             // æœ€åè®¿é—®æ—¶é—´
userData.devices                       // è®¾å¤‡åˆ—è¡¨
userData.suspend                       // å°ç¦çŠ¶æ€ï¼ˆåˆ°æœŸåè‡ªåŠ¨è§£é™¤ï¼‰
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### **1. é˜ˆå€¼è®¾ç½®**
```javascript
// æ¨èé…ç½®
SUSPEND_FAILED_ATTEMPTS_THRESHOLD: 5   // å¤±è´¥5æ¬¡å°ç¦
SUSPEND_THRESHOLD_PERCENT: 5           // è®¿é—®æ¬¡æ•°è¶…è¿‡5%å°ç¦
SUSPEND_REQUIRE_MAX_DEVICES: false     // ä»»ä½•è®¾å¤‡æ•°éƒ½å¯è§¦å‘
```

### **2. æµ‹è¯•å»ºè®®**
- ä½¿ç”¨å°çš„é˜ˆå€¼ï¼ˆå¦‚5æ¬¡ï¼‰å¿«é€Ÿæµ‹è¯•
- ç›‘æ§Cloudflareæ—¥å¿—ç¡®è®¤è®¡æ•°å™¨æ­£å¸¸å¢åŠ 
- ç¡®è®¤å°ç¦åTelegramé€šçŸ¥å‘é€
- ç¡®è®¤userDataæ­£ç¡®ä¿å­˜

### **3. ç”Ÿäº§ç¯å¢ƒ**
- å¯ä»¥é€‚å½“æé«˜é˜ˆå€¼ï¼ˆå¦‚10-20æ¬¡ï¼‰
- æ ¹æ®å®é™…æ»¥ç”¨æƒ…å†µè°ƒæ•´
- å®šæœŸæ£€æŸ¥å°ç¦æ—¥å¿—

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [é”™è¯¯é…ç½®ç”Ÿæˆæœºåˆ¶](./é”™è¯¯é…ç½®ç”Ÿæˆæœºåˆ¶.md) - Clashå®¢æˆ·ç«¯é”™è¯¯é…ç½®è¿”å›æœºåˆ¶
- [è´¦å·ä¸´æ—¶å°ç¦æœºåˆ¶](./è´¦å·ä¸´æ—¶å°ç¦æœºåˆ¶.md) - å°ç¦æœºåˆ¶è¯¦ç»†è¯´æ˜
- [åå…±äº«æœºåˆ¶æµ‹è¯•æ¸…å•](./åå…±äº«æœºåˆ¶æµ‹è¯•æ¸…å•.md) - å®Œæ•´æµ‹è¯•æµç¨‹

---

## ğŸ“… æ›´æ–°æ—¥å¿—

**2025-11-11**
- âœ… æ·»åŠ å¤±è´¥å°è¯•è®¡æ•°å™¨ï¼ˆ`failedAttempts`ï¼‰
- âœ… ä¿®æ”¹å°ç¦è§¦å‘æ¡ä»¶ï¼ˆæ”¯æŒå¤±è´¥å°è¯•è§¦å‘ï¼‰
- âœ… æ›´æ–°Telegramé€šçŸ¥ï¼ˆåŒºåˆ†å¤±è´¥å°è¯•å’Œè®¿é—®è¶…é™ï¼‰
- âœ… ç¡®ä¿å¤±è´¥è¯·æ±‚çš„userDataä¿å­˜
- âœ… æ¯æ—¥é‡ç½®æ—¶åŒæ—¶é‡ç½®å¤±è´¥è®¡æ•°å™¨
- âœ… æ·»åŠ é…ç½®é¡¹`SUSPEND_FAILED_ATTEMPTS_THRESHOLD`
